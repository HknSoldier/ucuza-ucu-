name: ğŸ¦… PROJECT TITAN â€“ Flight Intel Hunter

on:
  schedule:
    # Her 6 saatte bir Ã§alÄ±ÅŸ (UTC): 03:00, 09:00, 15:00, 21:00
    - cron: '0 3,9,15,21 * * *'
  workflow_dispatch:  # Manuel tetikleme

permissions:
  contents: write

jobs:
  hunt:
    name: ğŸ›°ï¸ UÃ§uÅŸ AvÄ±
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      # 1. Repoyu checkout et
      - name: ğŸ“¥ Repo Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Python kur
      - name: ğŸ Python 3.11 Kur
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3. Xvfb (sanal ekran)
      - name: ğŸ”§ Xvfb Kur
        run: sudo apt-get update -q && sudo apt-get install -y -q xvfb

      # 4. BaÄŸÄ±mlÄ±lÄ±klarÄ± kur
      - name: ğŸ“¦ Python BaÄŸÄ±mlÄ±lÄ±klarÄ± Kur
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 5. Playwright browser'Ä±nÄ± kur (deps olmadan â€” manuel kuruldu)
      - name: ğŸ­ Playwright Chromium Kur
        run: |
          python -m playwright install chromium --with-deps

      # 6. Mevcut state dosyalarÄ±nÄ± restore et (varsa)
      - name: ğŸ“‚ State DosyalarÄ± Kontrol
        run: |
          if [ ! -f history.json ]; then
            echo '{"alarms":[],"daily_count":0,"daily_date":""}' > history.json
            echo "history.json oluÅŸturuldu."
          fi
          if [ ! -f flights.json ]; then
            echo '{"last_updated":null,"total_found":0,"below_target":0,"flights":[]}' > flights.json
            echo "flights.json oluÅŸturuldu."
          fi

      # 7. Ana scraper'Ä± Ã§alÄ±ÅŸtÄ±r
      - name: ğŸš€ PROJECT TITAN Ã‡alÄ±ÅŸtÄ±r
        env:
          PYTHONUNBUFFERED: "1"
          DISPLAY: ":99"
        run: |
          echo "â° BaÅŸlangÄ±Ã§: $(date)"
          python scraper.py
          echo "âœ… BitiÅŸ: $(date)"
        continue-on-error: true  # Scraper Ã§Ã¶ksede commit yapÄ±lsÄ±n

      # 8. SonuÃ§larÄ± gÃ¶ster
      - name: ğŸ“Š SonuÃ§ Ã–zeti
        run: |
          echo "=== TITAN SONUÃ‡ Ã–ZETÄ° ==="
          if [ -f flights.json ]; then
            python3 -c "
          import json
          data = json.load(open('flights.json'))
          print(f'Toplam UÃ§uÅŸ: {data[\"total_found\"]}')
          print(f'Hedef AltÄ±:  {data[\"below_target\"]}')
          print(f'Son GÃ¼ncelleme: {data[\"last_updated\"]}')
          "
          fi
          if [ -f history.json ]; then
            python3 -c "
          import json
          h = json.load(open('history.json'))
          print(f'BugÃ¼nkÃ¼ Alarm SayÄ±sÄ±: {h[\"daily_count\"]}')
          "
          fi

      # 9. GÃ¼ncellenmiÅŸ dosyalarÄ± commit/push et
      - name: ğŸ’¾ SonuÃ§larÄ± Repoya Kaydet
        run: |
          git config --local user.email "titan-bot@github-actions"
          git config --local user.name "ğŸ¦… PROJECT TITAN Bot"
          
          git add flights.json history.json
          
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M UTC')
          TOTAL=$(python3 -c "import json; d=json.load(open('flights.json')); print(d['total_found'])" 2>/dev/null || echo "0")
          BELOW=$(python3 -c "import json; d=json.load(open('flights.json')); print(d['below_target'])" 2>/dev/null || echo "0")
          
          git commit -m "ğŸ¦… TITAN: ${TIMESTAMP} | ${TOTAL} uÃ§uÅŸ tarandÄ± | ${BELOW} hedef altÄ±" \
            --allow-empty || echo "Commit yapÄ±lacak deÄŸiÅŸiklik yok."
          
          git push || echo "Push baÅŸarÄ±sÄ±z (conflict olabilir, bir sonraki Ã§alÄ±ÅŸmada dÃ¼zelir)."

      # 10. Hata durumunda Telegram'a bildir
      - name: ğŸš¨ Hata Bildirimi
        if: failure()
        run: |
          python3 -c "
          import urllib.request, json, os
          token = '8161806410:AAH4tGpW_kCvQpLOfaB-r2OYQMypPVYtuYg'
          admin = '7684228928'
          import datetime
          msg = f'âš ï¸ PROJECT TITAN GitHub Actions HATASI\nğŸ“… {datetime.datetime.now().strftime(\"%Y-%m-%d %H:%M\")}\nğŸ”§ Workflow baÅŸarÄ±sÄ±z oldu. LoglarÄ± kontrol edin.'
          data = json.dumps({'chat_id': admin, 'text': msg}).encode()
          req = urllib.request.Request(
              f'https://api.telegram.org/bot{token}/sendMessage',
              data=data,
              headers={'Content-Type': 'application/json'}
          )
          urllib.request.urlopen(req, timeout=10)
          print('Hata bildirimi gÃ¶nderildi.')
          " || echo "Hata bildirimi gÃ¶nderilemedi."
