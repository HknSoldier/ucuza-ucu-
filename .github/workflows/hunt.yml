name: ğŸ¦… PROJECT TITAN â€“ Flight Intel Hunter

on:
  schedule:
    # UTC: 03:00, 09:00, 15:00, 21:00  â†’  TR: 06:00, 12:00, 18:00, 00:00
    - cron: '0 3,9,15,21 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  hunt:
    name: ğŸ›°ï¸ UÃ§uÅŸ AvÄ±
    runs-on: ubuntu-latest
    timeout-minutes: 90         # Playwright + tÃ¼m rotalar iÃ§in yeterli sÃ¼re

    steps:
      - name: ğŸ“¥ Repo Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Python 3.11 Kur
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # â”€â”€ Playwright kurulumu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Playwright Kur
        run: |
          pip install playwright
          playwright install chromium
          playwright install-deps chromium

      # â”€â”€ Sistem baÄŸÄ±mlÄ±lÄ±klarÄ± (Chromium iÃ§in) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ› ï¸ Sistem BaÄŸÄ±mlÄ±lÄ±klarÄ±
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            libnss3 libnspr4 libatk1.0-0 libatk-bridge2.0-0 \
            libcups2 libdrm2 libxkbcommon0 libxcomposite1 \
            libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2 \
            libpango-1.0-0 libcairo2 fonts-liberation \
            || true

      # â”€â”€ State dosyalarÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“‚ State DosyalarÄ± Kontrol
        run: |
          if [ ! -f history.json ]; then
            echo '{"alarms":[]}' > history.json
            echo "history.json oluÅŸturuldu."
          fi
          if [ ! -f flights.json ]; then
            echo '{"last_updated":null,"total_found":0,"below_target":0,"flights":[]}' > flights.json
            echo "flights.json oluÅŸturuldu."
          fi

      # â”€â”€ Ana scraper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸš€ PROJECT TITAN Ã‡alÄ±ÅŸtÄ±r
        env:
          PYTHONUNBUFFERED: "1"
          TITAN_BOT_TOKEN: ${{ secrets.TITAN_BOT_TOKEN }}
          TITAN_ADMIN_ID:  ${{ secrets.TITAN_ADMIN_ID }}
          TITAN_GROUP_ID:  ${{ secrets.TITAN_GROUP_ID }}
          # Playwright headless mod iÃ§in
          DISPLAY: ""
        run: |
          echo "â° BaÅŸlangÄ±Ã§: $(date)"
          python scraper.py
          echo "âœ… BitiÅŸ: $(date)"
        continue-on-error: true

      # â”€â”€ Ã–zet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“Š SonuÃ§ Ã–zeti
        run: |
          echo "=== TITAN SONUÃ‡ Ã–ZETÄ° ==="
          if [ -f flights.json ]; then
            python3 -c "
          import json
          d = json.load(open('flights.json'))
          print(f'Toplam UÃ§uÅŸ   : {d[\"total_found\"]}')
          print(f'Hedef AltÄ±    : {d[\"below_target\"]}')
          print(f'Bu Run Alarm  : {d.get(\"alarms_sent_this_run\", 0)}')
          print(f'Veri KaynaÄŸÄ±  : {d.get(\"data_source\", \"?\")}')
          print(f'Son GÃ¼ncelleme: {d[\"last_updated\"]}')
          "
          fi

      # â”€â”€ Commit / Push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ’¾ SonuÃ§larÄ± Repoya Kaydet
        run: |
          git config --local user.email "titan-bot@github-actions"
          git config --local user.name "ğŸ¦… PROJECT TITAN Bot"

          git add flights.json history.json

          TIMESTAMP=$(date '+%Y-%m-%d %H:%M UTC')
          TOTAL=$(python3 -c "import json; d=json.load(open('flights.json')); print(d['total_found'])" 2>/dev/null || echo "0")
          BELOW=$(python3 -c "import json; d=json.load(open('flights.json')); print(d['below_target'])" 2>/dev/null || echo "0")

          git commit -m "ğŸ¦… TITAN: ${TIMESTAMP} | ${TOTAL} uÃ§uÅŸ | ${BELOW} hedef altÄ±" \
            --allow-empty || echo "DeÄŸiÅŸiklik yok."

          git push || echo "Push baÅŸarÄ±sÄ±z."

      # â”€â”€ Hata bildirimi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸš¨ Hata Bildirimi
        if: failure()
        env:
          TITAN_BOT_TOKEN: ${{ secrets.TITAN_BOT_TOKEN }}
          TITAN_ADMIN_ID:  ${{ secrets.TITAN_ADMIN_ID }}
        run: |
          python3 -c "
          import urllib.request, json, os, datetime
          token = os.environ.get('TITAN_BOT_TOKEN', '')
          admin = os.environ.get('TITAN_ADMIN_ID', '')
          if not token or not admin:
              print('Token/Admin ID eksik, bildirim atlandÄ±.')
              exit(0)
          msg = f'âš ï¸ PROJECT TITAN HATASI\nğŸ“… {datetime.datetime.now().strftime(\"%Y-%m-%d %H:%M\")}\nğŸ”§ Workflow baÅŸarÄ±sÄ±z. LoglarÄ± kontrol et.'
          data = json.dumps({'chat_id': admin, 'text': msg}).encode()
          req = urllib.request.Request(
              f'https://api.telegram.org/bot{token}/sendMessage',
              data=data, headers={'Content-Type': 'application/json'}
          )
          urllib.request.urlopen(req, timeout=10)
          print('Hata bildirimi gÃ¶nderildi.')
          " || echo "Bildirim gÃ¶nderilemedi."
